<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absen Foto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        video, canvas, img { max-width: 100%; height: auto; border-radius: 0.75rem; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-6 max-w-2xl bg-white rounded-xl shadow-lg">

        <!-- ================================================== -->
        <!-- BAGIAN 1: FORM INPUT DATA PENGGUNA                 -->
        <!-- ================================================== -->
        <div id="user-form-section">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Verifikasi Identitas</h1>
                <p class="text-gray-500 mt-1">Silakan masukkan NRP Anda untuk melanjutkan.</p>
            </div>
            
            <div id="form-loader" class="text-center py-8">
                <p class="text-gray-600">Memuat data...</p>
            </div>

            <div id="form-content" class="hidden space-y-4">
                <div class="flex items-end gap-2">
                    <div class="flex-grow">
                        <label for="search-nrp-input" class="block mb-2 text-sm font-medium text-gray-900">NRP</label>
                        <input type="text" id="search-nrp-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Masukkan NRP Anda">
                    </div>
                    <button id="search-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-5 rounded-lg">Cari</button>
                </div>
                <p id="search-error" class="text-sm text-red-600 text-center h-4"></p>
                
                 <div>
                    <label class="block mb-2 text-sm font-medium text-gray-900">Nama Lengkap</label>
                    <input type="text" id="nama-output" class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" disabled>
                </div>
                 <div>
                    <label class="block mb-2 text-sm font-medium text-gray-900">Jabatan</label>
                    <input type="text" id="jabatan-output" class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" disabled>
                </div>
                 <div>
                    <label class="block mb-2 text-sm font-medium text-gray-900">RG</label>
                    <input type="text" id="rg-output" class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" disabled>
                </div>
                <button id="open-camera-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md disabled:bg-blue-300 disabled:cursor-not-allowed" disabled>
                    Lanjut Ambil Foto
                </button>
            </div>
        </div>

        <!-- ================================================== -->
        <!-- BAGIAN 2: PENGAMBILAN FOTO (WEBCAM)                -->
        <!-- ================================================== -->
        <div id="camera-section" class="hidden">
             <!-- Konten kamera sama persis seperti sebelumnya -->
             <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Ambil Foto Absen</h1>
                <p id="greeting" class="text-gray-500 mt-1">Arahkan wajah Anda ke kamera.</p>
            </div>
            <div id="camera-options" class="hidden mb-4">
                <label for="camera-select" class="block mb-2 text-sm font-medium text-gray-700">Pilih Kamera:</label>
                <select id="camera-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
            </div>
            <div id="media-container" class="relative w-full bg-gray-200 rounded-lg flex items-center justify-center aspect-video mb-4">
                <video id="webcam" autoplay playsinline class="w-full h-full object-cover"></video>
                <canvas id="canvas" class="hidden"></canvas>
                <img id="photo-preview" src="" alt="Preview Foto" class="hidden w-full h-full object-cover">
                <div id="error-message" class="hidden text-center p-4">
                    <p class="font-semibold text-red-600">Kamera tidak dapat diakses.</p>
                </div>
            </div>
            <div id="controls" class="flex flex-col sm:flex-row justify-center items-center gap-3">
                <button id="back-to-form-button" class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md">Kembali</button>
                <button id="capture-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">Ambil Foto</button>
                <button id="retake-button" class="w-full sm:w-auto hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md">Ulangi</button>
                <button id="submit-button" class="w-full sm:w-auto hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">Kirim Foto</button>
            </div>
            <div id="status-container" class="mt-4 text-center h-12 flex items-center justify-center">
                <div id="loader" class="hidden loader"></div>
                <p id="status-message" class="text-lg font-medium"></p>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMGzrg8a_dyemV9_YbV5GH6XxgsFLYLY9jWHPOtlwSque9eVI1njtTwMr5ulU957Bm/exec';
        let allUsersData = [];
        let foundUser = null;
        let currentStream;

        // --- Elemen Form Baru ---
        const searchNrpInput = document.getElementById('search-nrp-input');
        const searchButton = document.getElementById('search-button');
        const searchError = document.getElementById('search-error');
        const namaOutput = document.getElementById('nama-output');
        const jabatanOutput = document.getElementById('jabatan-output');
        const rgOutput = document.getElementById('rg-output');

        // --- Elemen Lama (masih digunakan) ---
        const userFormSection = document.getElementById('user-form-section');
        const formLoader = document.getElementById('form-loader');
        const formContent = document.getElementById('form-content');
        const openCameraButton = document.getElementById('open-camera-button');
        const cameraSection = document.getElementById('camera-section');
        const greeting = document.getElementById('greeting');
        const webcamElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');
        const photoPreviewElement = document.getElementById('photo-preview');
        const captureButton = document.getElementById('capture-button');
        const retakeButton = document.getElementById('retake-button');
        const submitButton = document.getElementById('submit-button');
        const backToFormButton = document.getElementById('back-to-form-button');
        const cameraOptions = document.getElementById('camera-options');
        const cameraSelect = document.getElementById('camera-select');
        const errorMessage = document.getElementById('error-message');
        const loader = document.getElementById('loader');
        const statusMessage = document.getElementById('status-message');

        // DIUBAH: Fetch data dan simpan di memori
        async function fetchUserData() {
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const result = await response.json();
                if (result.status === 'success') {
                    allUsersData = result.data;
                    formLoader.classList.add('hidden');
                    formContent.classList.remove('hidden');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                formLoader.innerHTML = `<p class="text-red-600">Gagal memuat data: ${error.message}</p>`;
            }
        }
        
        // BARU: Fungsi untuk mencari pengguna berdasarkan NRP
        function findUser() {
            const nrpToFind = searchNrpInput.value.trim();
            if (!nrpToFind) {
                searchError.textContent = 'NRP tidak boleh kosong.';
                return;
            }

            foundUser = allUsersData.find(user => user.NRP.toLowerCase() === nrpToFind.toLowerCase());

            if (foundUser) {
                searchError.textContent = '';
                namaOutput.value = foundUser.Nama;
                jabatanOutput.value = foundUser.Jabatan;
                rgOutput.value = foundUser.RG;
                openCameraButton.disabled = false;
            } else {
                searchError.textContent = 'NRP tidak ditemukan.';
                namaOutput.value = '';
                jabatanOutput.value = '';
                rgOutput.value = '';
                openCameraButton.disabled = true;
                foundUser = null;
            }
        }

        // DIUBAH: Mengirim data dari `foundUser`
        async function submitPhoto() {
            loader.classList.remove('hidden');
            statusMessage.textContent = 'Mengirim foto...';
            retakeButton.disabled = true;
            submitButton.disabled = true;

            const base64Data = canvasElement.toDataURL('image/jpeg').split(',')[1];
            
            const payload = { 
                imageData: base64Data,
                nrp: foundUser.NRP,
                nama: foundUser.Nama,
                rg: foundUser.RG,
                jabatan: foundUser.Jabatan
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    statusMessage.textContent = 'Sukses! Halaman akan dimuat ulang...';
                    statusMessage.className = 'text-lg font-medium text-green-600';
                    setTimeout(() => location.reload(), 2000);
                } else {
                    throw new Error(result.message || 'Gagal mengirim foto.');
                }
            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}`;
                statusMessage.className = 'text-lg font-medium text-red-600';
                retakeButton.disabled = false;
                submitButton.disabled = false;
                loader.classList.add('hidden');
            }
        }

        // --- Fungsi-fungsi lain (tidak berubah) ---
        function showCameraView() { if (!foundUser) return; userFormSection.classList.add('hidden'); cameraSection.classList.remove('hidden'); greeting.textContent = `Halo, ${foundUser.Nama}!`; initializeCamera(); }
        function showFormView() { cameraSection.classList.add('hidden'); userFormSection.classList.remove('hidden'); if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); } retakePhoto(); }
        async function initializeCamera() { try { const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false }); stream.getTracks().forEach(track => track.stop()); const devices = await navigator.mediaDevices.enumerateDevices(); const videoDevices = devices.filter(device => device.kind === 'videoinput'); if (videoDevices.length === 0) throw new Error("Tidak ada kamera ditemukan."); cameraSelect.innerHTML = ''; videoDevices.forEach((device, index) => { const option = document.createElement('option'); option.value = device.deviceId; option.text = device.label || `Kamera ${index + 1}`; cameraSelect.appendChild(option); }); if (videoDevices.length > 1) cameraOptions.classList.remove('hidden'); await startWebcam(videoDevices[0].deviceId); } catch (err) { errorMessage.classList.remove('hidden'); webcamElement.classList.add('hidden'); captureButton.classList.add('hidden'); } }
        async function startWebcam(deviceId) { if (currentStream) currentStream.getTracks().forEach(track => track.stop()); const constraints = { video: { deviceId: { exact: deviceId } }, audio: false }; try { const stream = await navigator.mediaDevices.getUserMedia(constraints); webcamElement.srcObject = stream; currentStream = stream; webcamElement.classList.remove('hidden'); errorMessage.classList.add('hidden'); captureButton.classList.remove('hidden'); } catch (err) { errorMessage.classList.remove('hidden'); webcamElement.classList.add('hidden'); captureButton.classList.add('hidden'); } }
        function takePhoto() { const videoWidth = webcamElement.videoWidth; const videoHeight = webcamElement.videoHeight; canvasElement.width = videoWidth; canvasElement.height = videoHeight; canvasElement.getContext('2d').drawImage(webcamElement, 0, 0, videoWidth, videoHeight); photoPreviewElement.src = canvasElement.toDataURL('image/jpeg'); webcamElement.classList.add('hidden'); photoPreviewElement.classList.remove('hidden'); captureButton.classList.add('hidden'); backToFormButton.classList.add('hidden'); retakeButton.classList.remove('hidden'); submitButton.classList.remove('hidden'); }
        function retakePhoto() { photoPreviewElement.classList.add('hidden'); webcamElement.classList.remove('hidden'); retakeButton.classList.add('hidden'); submitButton.classList.add('hidden'); captureButton.classList.remove('hidden'); backToFormButton.classList.remove('hidden'); statusMessage.textContent = ''; }

        // --- Event Listeners ---
        window.addEventListener('load', fetchUserData);
        searchButton.addEventListener('click', findUser);
        searchNrpInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') findUser(); }); // Cari saat menekan Enter
        openCameraButton.addEventListener('click', showCameraView);
        backToFormButton.addEventListener('click', showFormView);
        cameraSelect.addEventListener('change', () => startWebcam(cameraSelect.value));
        captureButton.addEventListener('click', takePhoto);
        retakeButton.addEventListener('click', retakePhoto);
        submitButton.addEventListener('click', submitPhoto);
    </script>
</body>
</html>
